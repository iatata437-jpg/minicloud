<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MiniCloud – Панель</title>

    <link rel="stylesheet" href="style.css">

    <style>
        body {
            background: linear-gradient(135deg, #e8efff, #f7f2ff);
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        .panel-container {
            width: 900px;
            background: white;
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 0 40px rgba(0,0,0,0.10);
        }

        h2 {
            margin: 0 0 25px;
            font-size: 28px;
            text-align: center;
            color: #4a4a4a;
        }

        .upload-box {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        input[type="file"] {
            background: #f3f3f3;
            padding: 12px;
            border: 1px solid #dcdcdc;
            border-radius: 10px;
            font-size: 15px;
            width: 65%;
        }

        button {
            padding: 12px 20px;
            background: #6a5acd;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: .2s;
        }

        button:hover {
            background: #5948c4;
        }

        #progress {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        #progress div {
            height: 100%;
            background: #6a5acd;
            width: 0%;
            transition: width 0.1s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }

        th, td {
            padding: 14px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
        }

        th {
            background: #fafafa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f5ff;
        }

        a {
            color: #6a5acd;
            font-weight: 600;
        }

        .delete-btn {
            background: #ff5d5d;
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
        }

        .delete-btn:hover {
            background: #ff3d3d;
        }

        .logout-btn {
            margin-top: 20px;
            float: right;
            background: #d9534f;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .logout-btn:hover {
            background: #c9302c;
        }
    </style>
</head>

<body>

<div class="panel-container">

    <h2>Ваши файлы</h2>

    <div class="upload-box">
        <input type="file" id="fileInput">
        <button onclick="upload()">Загрузить</button>
    </div>

    <div id="progress"><div></div></div>

    <table>
        <thead>
        <tr>
            <th>Название файла</th>
            <th>Размер</th>
            <th>Скачать</th>
            <th>Удалить</th>
        </tr>
        </thead>
        <tbody id="fileTable"></tbody>
    </table>

    <button class="logout-btn" onclick="logout()">Выйти</button>

</div>


<script>
    // Проверка токена
    const token = localStorage.getItem("token");
    if (!token) location.href = "/index.html";

    // Выход из акаунта
    function logout() {
        localStorage.removeItem("token");
        location.href = "/index.html";
    }

    // Загрузка списка файлов
    async function loadFiles() {
        const res = await fetch('/files', {
            headers: { 'Authorization': token }
        });

        const data = await res.json();
        const table = document.getElementById("fileTable");
        table.innerHTML = "";

        data.files.forEach(file => {
            table.innerHTML += `
                <tr>
                    <td>${file.name}</td>
                    <td>${(file.size / 1024 / 1024).toFixed(2)} MB</td>
                    <td>
                        <a href="/files/${file.name}" 
                           onclick="event.preventDefault(); downloadFile('${file.name}')">
                           Скачать
                        </a>
                    </td>
                    <td><button class="delete-btn" onclick="deleteFile('${file.name}')">Удалить</button></td>
                </tr>
            `;
        });
    }


    // Скачать файл корректно (через заголовок)
    function downloadFile(name) {
        const url = `/files/${name}`;

        fetch(url, {
            headers: { "Authorization": token }
        })
        .then(res => res.blob())
        .then(blob => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        });
    }


    // Удаление файла
    async function deleteFile(name) {
        if (!confirm(`Удалить файл "${name}"?`)) return;

        await fetch('/files/' + name, {
            method: 'DELETE',
            headers: { 'Authorization': token }
        });

        loadFiles();
    }

    // Загрузка файла с прогресс-баром
    function upload() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return alert("Выберите файл!");

        const formData = new FormData();
        formData.append("file", file);

        const progress = document.getElementById("progress");
        const bar = progress.firstElementChild;

        progress.style.display = "block";
        bar.style.width = "0%";

        const req = new XMLHttpRequest();
        req.open("POST", "/upload");
        req.setRequestHeader("Authorization", token);

        req.upload.onprogress = e => {
            if (e.lengthComputable) {
                bar.style.width = (e.loaded / e.total * 100) + "%";
            }
        };

        req.onload = () => {
            progress.style.display = "none";
            loadFiles();
        };

        req.send(formData);
    }

    // Загружаем список сразу
    loadFiles();
</script>

</body>
</html>
