<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MiniCloud ‚Äì –ü–∞–Ω–µ–ª—å</title>

    <link rel="stylesheet" href="style.css">

    <style>
        /* ---------------- –¢–ï–ú–´ ---------------- */
        :root {
            --bg-color: #e8efff;
            --bg2-color: #f7f2ff;
            --panel-bg: #ffffff;
            --text-color: #000000;
            --border-color: #dddddd;
            --th-bg: #fafafa;
            --tr-hover: #f8f5ff;
            --file-input-bg: #f3f3f3;
            --btn-bg: #6a5acd;
            --btn-text: #ffffff;
            --delete-bg: #ff5d5d;
            --delete-bg-hover: #ff3d3d;
            --logout-bg: #d9534f;
            --logout-hover: #c9302c;
        }

        .dark {
            --bg-color: #121212;
            --bg2-color: #121212;
            --panel-bg: #1f1f1f;
            --text-color: #ffffff;
            --border-color: #2e2e2e;
            --th-bg: #262626;
            --tr-hover: #2f2f2f;
            --file-input-bg: #292929;
            --btn-bg: #8a7aff;
            --btn-text: #ffffff;
            --delete-bg: #ff4444;
            --delete-bg-hover: #ff2222;
            --logout-bg: #b52a27;
            --logout-hover: #9d1c19;
        }

        body {
            background: linear-gradient(135deg, var(--bg-color), var(--bg2-color));
            margin: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 40px;
            color: var(--text-color);
            transition: 0.3s ease;
        }

        .panel-container {
            width: 900px;
            background: var(--panel-bg);
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 0 40px rgba(0,0,0,0.10);
        }

        h2 {
            margin: 0 0 25px;
            font-size: 28px;
            text-align: center;
        }

        #dropZone {
            border: 2px dashed #6a5acd;
            padding: 20px;
            border-radius: 12px;
            transition: 0.3s;
            margin-bottom: 10px;
        }
        #dropZone.dragover {
            background: rgba(106,90,205,0.15);
            border-color: #8a7aff;
        }

        #themeToggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            padding: 10px 14px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px; border-bottom: 1px solid var(--border-color); }

        tr:hover { background: var(--tr-hover); }

        .delete-btn {
            background: var(--delete-bg);
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .delete-btn:hover { background: var(--delete-bg-hover); }

        .folder { font-weight: bold; cursor: pointer; }
        .path-box { margin-bottom: 10px; font-size: 14px; opacity: 0.8; }

        .btn-create-folder {
            margin: 10px 0;
            background: #4a7aff;
            padding: 8px 14px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .btn-back {
            margin-right: 10px;
            padding: 6px 12px;
            border-radius: 8px;
            background: #999;
            color: white;
            cursor: pointer;
        }

        /* ===== –ú–û–î–ê–õ–ö–ò ===== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(3px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 16px;
            width: 350px;
            box-shadow: 0 0 25px rgba(0,0,0,0.25);
            animation: popup .25s ease;
        }

        @keyframes popup {
            from { transform: scale(.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content h3 { margin: 0; text-align: center; }
        .modal-content p { text-align: center; }

        .modal-input {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--file-input-bg);
            color: var(--text-color);
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .btn-ok, .btn-cancel, .btn-delete {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            color: white;
        }

        .btn-ok { background: var(--btn-bg); }
        .btn-cancel { background: #777; }
        .btn-delete { background: var(--delete-bg); }
    </style>
</head>

<body>

<!-- ===== –ú–û–î–ê–õ–ö–ê –°–û–ó–î–ê–ù–ò–Ø –ü–ê–ü–ö–ò ===== -->
<div id="folderModal" class="modal">
    <div class="modal-content">
        <h3>–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h3>
        <input id="folderName" class="modal-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏">
        <div class="modal-buttons">
            <button class="btn-ok" onclick="confirmCreateFolder()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="btn-cancel" onclick="closeFolderModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- ===== –ú–û–î–ê–õ–ö–ê –£–î–ê–õ–ï–ù–ò–Ø ===== -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>–£–¥–∞–ª–µ–Ω–∏–µ</h3>
        <p id="deleteText"></p>
        <div class="modal-buttons">
            <button class="btn-delete" id="deleteYes">–£–¥–∞–ª–∏—Ç—å</button>
            <button class="btn-cancel" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- ===== –ú–û–î–ê–õ–ö–ê –û–®–ò–ë–ö–ò ===== -->
<div id="errorModal" class="modal">
    <div class="modal-content">
        <h3>–û—à–∏–±–∫–∞</h3>
        <p id="errorText"></p>
        <div class="modal-buttons" style="justify-content:center">
            <button class="btn-ok" onclick="closeErrorModal()">OK</button>
        </div>
    </div>
</div>

<button id="themeToggle">üåì</button>

<div class="panel-container">

    <h2>–í–∞—à–∏ —Ñ–∞–π–ª—ã</h2>

    <div class="path-box">üìÇ –ü—É—Ç—å: <span id="currentPathView">/</span></div>

    <div>
        <button class="btn-back" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn-create-folder" onclick="openFolderModal()">+ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
    </div>

    <div id="dropZone">
        <input type="file" id="fileInput">
        <button onclick="upload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>

    <div id="progress"><div></div></div>

    <table>
        <thead>
            <tr><th>–ò–º—è</th><th>–†–∞–∑–º–µ—Ä</th><th></th></tr>
        </thead>
        <tbody id="fileTable"></tbody>
    </table>

    <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<script>

/* --- –¢–µ–º–∞ --- */
if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark");
themeToggle.onclick = () => {
    document.body.classList.toggle("dark");
    localStorage.setItem("theme",
        document.body.classList.contains("dark") ? "dark" : "light");
};

/* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --- */
const token = localStorage.getItem("token");
if (!token) location.href = "/index.html";

/* --- –ü—É—Ç—å --- */
let currentPath = "";

/* --- –ú–æ–¥–∞–ª–∫–∞ –æ—à–∏–±–∫–∏ --- */
function showError(text) {
    document.getElementById("errorText").innerText = text;
    document.getElementById("errorModal").style.display = "flex";
}
function closeErrorModal() {
    document.getElementById("errorModal").style.display = "none";
}

/* --- –ú–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è --- */
let deleteCallback = null;

function openDeleteModal(name) {
    document.getElementById("deleteText").innerText = `–£–¥–∞–ª–∏—Ç—å "${name}"?`;
    document.getElementById("deleteModal").style.display = "flex";

    deleteCallback = () => {
        processDelete(name);
        closeDeleteModal();
    };
}

function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
}

document.getElementById("deleteYes").onclick = () => {
    if (deleteCallback) deleteCallback();
};

/* --- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏ --- */
function openFolderModal() {
    folderModal.style.display = "flex";
    folderName.value = "";
    setTimeout(() => folderName.focus(), 50);
}

function closeFolderModal() {
    folderModal.style.display = "none";
}

async function confirmCreateFolder() {
    const name = folderName.value.trim();
    if (!name) return showError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏!");

    await fetch("/create-folder", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": token
        },
        body: JSON.stringify({ name, path: currentPath })
    });

    closeFolderModal();
    loadFiles();
}

/* --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ --- */
function updatePathView() {
    currentPathView.innerText = currentPath || "/";
}

/* --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ --- */
async function loadFiles() {
    const res = await fetch(`/files?path=${encodeURIComponent(currentPath)}`, {
        headers: { "Authorization": token }
    });

    const data = await res.json();
    const table = document.getElementById("fileTable");
    table.innerHTML = "";

    updatePathView();

    // –ü–∞–ø–∫–∏
    data.files.filter(f => f.isFolder).forEach(folder => {
        table.innerHTML += `
        <tr class="folder" onclick="enterFolder('${folder.name}')">
            <td>üìÅ ${folder.name}</td>
            <td>‚Äî</td>
            <td>
                <button class="delete-btn"
                    onclick="event.stopPropagation(); openDeleteModal('${folder.name}')">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </td>
        </tr>`;
    });

    // –§–∞–π–ª—ã
    data.files.filter(f => !f.isFolder).forEach(file => {
        table.innerHTML += `
        <tr>
            <td>${file.name}</td>
            <td>${(file.size/1024/1024).toFixed(2)} MB</td>
            <td>
                <a href="#" onclick="event.preventDefault(); downloadFile('${file.name}')">–°–∫–∞—á–∞—Ç—å</a>
                <button class="delete-btn" onclick="openDeleteModal('${file.name}')">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>`;
    });
}

/* --- –í—Ö–æ–¥ –≤ –ø–∞–ø–∫—É --- */
function enterFolder(name) {
    currentPath = currentPath ? currentPath + "/" + name : name;
    loadFiles();
}

/* --- –ù–∞–∑–∞–¥ --- */
function goBack() {
    if (!currentPath) return;
    const parts = currentPath.split("/");
    parts.pop();
    currentPath = parts.join("/");
    loadFiles();
}

/* --- –£–¥–∞–ª–µ–Ω–∏–µ --- */
async function processDelete(name) {
    await fetch(`/files/${name}?path=${encodeURIComponent(currentPath)}`, {
        method: "DELETE",
        headers: { "Authorization": token }
    });

    loadFiles();
}

/* --- –°–∫–∞—á–∞—Ç—å --- */
function downloadFile(name) {
    fetch(`/files/${name}?path=${encodeURIComponent(currentPath)}`, {
        headers: { "Authorization": token }
    })
    .then(r => r.blob())
    .then(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
    });
}

/* --- Upload --- */
function upload() {
    const file = fileInput.files[0];
    if (!file) return showError("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");

    const formData = new FormData();
    formData.append("file", file);

    progress.style.display = "block";
    progress.firstElementChild.style.width = "0%";

    const req = new XMLHttpRequest();
    req.open("POST", `/upload?path=${encodeURIComponent(currentPath)}`);
    req.setRequestHeader("Authorization", token);

    req.upload.onprogress = e => {
        if (e.lengthComputable)
            progress.firstElementChild.style.width = (e.loaded/e.total*100) + "%";
    };

    req.onload = () => {
        progress.style.display = "none";
        loadFiles();
    };

    req.send(formData);
}

/* --- Drag&Drop --- */
dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    fileInput.files = e.dataTransfer.files;
    upload();
});

loadFiles();

</script>

</body>
</html>
